- name: disabled default NodeJS 16
  ansible.builtin.shell: dnf module disable nodejs -y

- name: enable Nodejs 20 version
  ansible.builtin.shell: dnf module enable nodejs:20 -y

- name: install Nodejs
  ansible.builtin.dnf:
   name: nodejs
   state: installed

- name: user all ready  exit or not
  ansible.builtin.shell: id expense
  ignore_errors: true
  register: USER

- name: prent the user data
  ansible.builtin.debug:
   msg: "output {{ USER }}"

- name: Add expense user
  ansible.builtin.user:
   name: expense
  when: USER.rc != 0

- name: Create a directory
  ansible.builtin.file:
   path: /app
   state: directory

- name: Download backend files
  ansible.builtin.unarchive:
   src: https://expense-builds.s3.us-east-1.amazonaws.com/expense-backend-v2.zip
   dest: /app
   remote_src: yes

- name: install npm dependencies
  ansible.builtin.shell: npm install
  args:
   chdir: /app

- name: setup systemd service fire
  ansible.builtin.template:
   src: backend.service.j2
   dest: /etc/systemd/system/backend.service

- name: daemon reload
  ansible.builtin.systemd:
   daemon_reload: yes

- name: Start and enable backend service
  ansible.builtin.service:
   name: backend
   state: restarted
   enabled: yes
